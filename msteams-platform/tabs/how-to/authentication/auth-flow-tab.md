---
title: 选项卡的身份验证流
description: 描述选项卡中的身份验证流
ms.topic: conceptual
localization_priority: Normal
keywords: teams 身份验证流选项卡
ms.openlocfilehash: 1282c149beba0ff5b424585f566a703f48234fa2
ms.sourcegitcommit: 51e4a1464ea58c254ad6bd0317aca03ebf6bf1f6
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 05/19/2021
ms.locfileid: "52566689"
---
# <a name="microsoft-teams-authentication-flow-for-tabs"></a><span data-ttu-id="78dc8-104">Microsoft Teams选项卡的身份验证流</span><span class="sxs-lookup"><span data-stu-id="78dc8-104">Microsoft Teams authentication flow for tabs</span></span>

> [!NOTE]
> <span data-ttu-id="78dc8-105">若要在移动客户端上对选项卡进行身份验证，必须确保使用的是至少 1.4.1 版本的 Microsoft Teams JavaScript SDK。</span><span class="sxs-lookup"><span data-stu-id="78dc8-105">For authentication to work for your tab on mobile clients, you must ensure you are using at least 1.4.1 version of the Microsoft Teams JavaScript SDK.</span></span>
> <span data-ttu-id="78dc8-106">TeamsSDK 为身份验证流启动单独的窗口。</span><span class="sxs-lookup"><span data-stu-id="78dc8-106">Teams SDK launches separate window for authentication flow.</span></span> <span data-ttu-id="78dc8-107">将 `SameSite` 属性设置为 **Lax**。</span><span class="sxs-lookup"><span data-stu-id="78dc8-107">Set the `SameSite` attribute to **Lax**.</span></span> <span data-ttu-id="78dc8-108">Teams版桌面客户端或较旧版本的 Chrome 或 Safari 不支持 `SameSite` =None。</span><span class="sxs-lookup"><span data-stu-id="78dc8-108">Teams desktop client or older versions of Chrome or Safari do not support `SameSite`=None.</span></span>

<span data-ttu-id="78dc8-109">OAuth 2.0 是一个开放标准，供 AAD Azure Active Directory (和许多其他) 使用的身份验证和授权。</span><span class="sxs-lookup"><span data-stu-id="78dc8-109">OAuth 2.0 is an open standard for authentication and authorization used by Azure Active Directory (AAD) and many other identity providers.</span></span> <span data-ttu-id="78dc8-110">对 OAuth 2.0 有基本的了解是在 Teams 中进行身份验证的先决条件。</span><span class="sxs-lookup"><span data-stu-id="78dc8-110">A basic understanding of OAuth 2.0 is a prerequisite for working with authentication in Teams.</span></span> <span data-ttu-id="78dc8-111">有关详细信息，请参阅 [OAuth 2 简化](https://aaronparecki.com/oauth-2-simplified/) ，比正式规范 [更易于遵循](https://oauth.net/2/)。</span><span class="sxs-lookup"><span data-stu-id="78dc8-111">For more information, see [OAuth 2 simplified](https://aaronparecki.com/oauth-2-simplified/) that is easier to follow than the [formal specification](https://oauth.net/2/).</span></span> <span data-ttu-id="78dc8-112">选项卡和聊天机器人的身份验证流不同，因为选项卡类似于网站，因此可以直接使用 OAuth 2.0。</span><span class="sxs-lookup"><span data-stu-id="78dc8-112">Authentication flow for tabs and bots are different because tabs are similar to websites so they can use OAuth 2.0 directly.</span></span> <span data-ttu-id="78dc8-113">机器人执行一些不同操作，但核心概念是相同的。</span><span class="sxs-lookup"><span data-stu-id="78dc8-113">Bots do a few things differently, but the core concepts are identical.</span></span>

<span data-ttu-id="78dc8-114">有关使用 Node 和 [OAuth 2.0](https://oauth.net/2/grant-types/implicit/)隐式授予类型的选项卡和自动程序身份验证流的示例，请参阅 [启动选项卡的身份验证流](~/tabs/how-to/authentication/auth-tab-aad.md#initiate-authentication-flow)。</span><span class="sxs-lookup"><span data-stu-id="78dc8-114">For an example of authentication flow for tabs and bots using Node and the [OAuth 2.0 implicit grant type](https://oauth.net/2/grant-types/implicit/), see [initiate authentication flow for tabs](~/tabs/how-to/authentication/auth-tab-aad.md#initiate-authentication-flow).</span></span>

> [!NOTE]
> <span data-ttu-id="78dc8-115">在向 **用户显示登录** 按钮并调用 API 以响应选择该按钮之前，必须等待 `microsoftTeams.authentication.authenticate` SDK 初始化完成。</span><span class="sxs-lookup"><span data-stu-id="78dc8-115">Before showing a **Login** button to the user and calling the `microsoftTeams.authentication.authenticate` API in response to selecting the button, you must wait for the SDK initialization to complete.</span></span> <span data-ttu-id="78dc8-116">你可以将回调传递到 `microsoftTeams.initialize` 初始化完成时调用的 API。</span><span class="sxs-lookup"><span data-stu-id="78dc8-116">You can pass a callback to the `microsoftTeams.initialize` API that is called when initialization completes.</span></span>

![选项卡身份验证序列图](~/assets/images/authentication/tab_auth_sequence_diagram.png)

1. <span data-ttu-id="78dc8-118">用户与选项卡配置或内容页上的内容交互，通常为" **登录** "或" **登录"** 按钮。</span><span class="sxs-lookup"><span data-stu-id="78dc8-118">The user interacts with the content on the tab configuration or content page, commonly a **Sign in** or **Log in** button.</span></span>
2. <span data-ttu-id="78dc8-119">选项卡将构造其身份验证起始页的 URL。</span><span class="sxs-lookup"><span data-stu-id="78dc8-119">The tab constructs the URL for its auth start page.</span></span> <span data-ttu-id="78dc8-120">（可选）它使用 URL 占位符的信息或Teams `microsoftTeams.getContext()` 客户端 SDK 方法，以简化用户的身份验证体验。</span><span class="sxs-lookup"><span data-stu-id="78dc8-120">Optionally, it uses information from URL placeholders or calls `microsoftTeams.getContext()` Teams client SDK method to streamline the authentication experience for the user.</span></span> <span data-ttu-id="78dc8-121">例如，使用 AAD 进行身份验证时，如果参数设置为用户的电子邮件地址，则如果用户最近已登录，则无需 `login_hint` 登录。</span><span class="sxs-lookup"><span data-stu-id="78dc8-121">For example, when authenticating with AAD, if the `login_hint` parameter is set to the user's email address, the user does not have to sign in if they have done so recently.</span></span> <span data-ttu-id="78dc8-122">这是因为 AAD 使用用户的缓存凭据。</span><span class="sxs-lookup"><span data-stu-id="78dc8-122">This is because AAD uses the user's cached credentials.</span></span> <span data-ttu-id="78dc8-123">弹出窗口短暂显示，然后消失。</span><span class="sxs-lookup"><span data-stu-id="78dc8-123">The pop-up window is shown briefly and then disappears.</span></span>
3. <span data-ttu-id="78dc8-124">然后选项卡调用 `microsoftTeams.authentication.authenticate()` 方法，并注册 `successCallback` 和 `failureCallback` 函数。</span><span class="sxs-lookup"><span data-stu-id="78dc8-124">The tab then calls the `microsoftTeams.authentication.authenticate()` method and registers the `successCallback` and `failureCallback` functions.</span></span>
4. <span data-ttu-id="78dc8-125">Teams弹出窗口中的 iframe 中打开起始页。</span><span class="sxs-lookup"><span data-stu-id="78dc8-125">Teams opens the start page in an iframe in a pop-up window.</span></span> <span data-ttu-id="78dc8-126">起始页将生成随机数据、保存数据供将来验证，并重定向到标识提供程序的终结点，如 `state` `/authorize` Azure `https://login.microsoftonline.com/<tenant ID>/oauth2/authorize` AD。</span><span class="sxs-lookup"><span data-stu-id="78dc8-126">The start page generates random `state` data, saves it for future validation, and redirects to the identity provider's `/authorize` endpoint, such as `https://login.microsoftonline.com/<tenant ID>/oauth2/authorize` for Azure AD.</span></span> <span data-ttu-id="78dc8-127">将 `<tenant id>` 替换为你自己的租户 ID，即 context.tid。</span><span class="sxs-lookup"><span data-stu-id="78dc8-127">Replace `<tenant id>` with your own tenant id that is context.tid.</span></span>
<span data-ttu-id="78dc8-128">与应用程序中的Teams身份验证流类似，起始页必须位于其列表中的域上，并且必须与登录后重定向页位于同一 `validDomains` 域中。</span><span class="sxs-lookup"><span data-stu-id="78dc8-128">Similar to other application auth flows in Teams, the start page must be on a domain that is in its `validDomains` list, and on the same domain as the post sign in redirect page.</span></span>

    > [!NOTE]
    > <span data-ttu-id="78dc8-129">OAuth 2.0 隐式授权流调用身份验证请求中的参数，其中包含唯一的会话数据以防止 `state` 跨站点请求 [伪造攻击](https://en.wikipedia.org/wiki/Cross-site_request_forgery)。</span><span class="sxs-lookup"><span data-stu-id="78dc8-129">The OAuth 2.0 implicit grant flow calls for a `state` parameter in the authentication request, which contains unique session data to prevent a [cross-site request forgery attack](https://en.wikipedia.org/wiki/Cross-site_request_forgery).</span></span> <span data-ttu-id="78dc8-130">这些示例对数据使用随机生成的 `state` GUID。</span><span class="sxs-lookup"><span data-stu-id="78dc8-130">The examples use a randomly-generated GUID for the `state` data.</span></span>

5. <span data-ttu-id="78dc8-131">在提供商网站上，用户登录并授予对选项卡的访问权限。</span><span class="sxs-lookup"><span data-stu-id="78dc8-131">On the provider's site, the user signs in and grants access to the tab.</span></span>
6. <span data-ttu-id="78dc8-132">提供程序将用户定向到具有访问令牌的选项卡的 OAuth 2.0 重定向页面。</span><span class="sxs-lookup"><span data-stu-id="78dc8-132">The provider takes the user to the tab's OAuth 2.0 redirect page with an access token.</span></span>
7. <span data-ttu-id="78dc8-133">该选项卡检查返回的值是否与之前保存的值匹配，并调用 ，这反过来调用在步骤 3 中注册 `state` `microsoftTeams.authentication.notifySuccess()` `successCallback` 的函数。</span><span class="sxs-lookup"><span data-stu-id="78dc8-133">The tab checks that the returned `state` value matches what was saved earlier, and calls `microsoftTeams.authentication.notifySuccess()`, which in turn calls the `successCallback` function registered in step 3.</span></span>
8. <span data-ttu-id="78dc8-134">Teams关闭弹出窗口。</span><span class="sxs-lookup"><span data-stu-id="78dc8-134">Teams closes the pop-up window.</span></span>
9. <span data-ttu-id="78dc8-135">选项卡显示配置 UI、刷新或重新加载选项卡内容，具体取决于用户从何处开始。</span><span class="sxs-lookup"><span data-stu-id="78dc8-135">The tab either displays configuration UI, refreshes, or reloads the tabs content, depending on where the user started from.</span></span>

## <a name="treat-tab-context-as-hints"></a><span data-ttu-id="78dc8-136">将选项卡上下文视为提示</span><span class="sxs-lookup"><span data-stu-id="78dc8-136">Treat tab context as hints</span></span>

<span data-ttu-id="78dc8-137">尽管选项卡上下文提供了有关用户的有用信息，但请勿使用此信息对用户进行身份验证。</span><span class="sxs-lookup"><span data-stu-id="78dc8-137">Although the tab context provides helpful information regarding the user, do not use this information to authenticate the user.</span></span> <span data-ttu-id="78dc8-138">即使您将信息作为 URL 参数获取至您的选项卡内容 URL，或者通过调用 Microsoft Teams SDK 中的 函数， `microsoftTeams.getContext()` 也可以对用户进行身份验证。</span><span class="sxs-lookup"><span data-stu-id="78dc8-138">Do authenticate the user even if you get the information as URL parameters to your tab content URL or by calling the `microsoftTeams.getContext()` function in the Microsoft Teams client SDK.</span></span> <span data-ttu-id="78dc8-139">恶意参与者可以使用自己的参数调用您的选项卡内容 URL。</span><span class="sxs-lookup"><span data-stu-id="78dc8-139">A malicious actor can invoke your tab content URL with its own parameters.</span></span> <span data-ttu-id="78dc8-140">参与者还可以调用模拟 web 页面Microsoft Teams在 iframe 中加载选项卡内容 URL，并返回其自己的 `getContext()` 数据到 函数。</span><span class="sxs-lookup"><span data-stu-id="78dc8-140">The actor can also invoke a web page impersonating Microsoft Teams to load your tab content URL in an iframe and return its own data to the `getContext()` function.</span></span> <span data-ttu-id="78dc8-141">你必须将选项卡上下文中的标识相关信息视为提示，并验证这些信息，然后再使用。</span><span class="sxs-lookup"><span data-stu-id="78dc8-141">You must treat the identity-related information in the tab context simply as hints and validate them before use.</span></span> <span data-ttu-id="78dc8-142">请参阅从弹出式页面导航到 [授权页中的注释](~/tabs/how-to/authentication/auth-tab-aad.md#navigate-to-the-authorization-page-from-your-popup-page)。</span><span class="sxs-lookup"><span data-stu-id="78dc8-142">Refer to the notes in [navigate to the authorization page from your pop-up page](~/tabs/how-to/authentication/auth-tab-aad.md#navigate-to-the-authorization-page-from-your-popup-page).</span></span>

## <a name="code-sample"></a><span data-ttu-id="78dc8-143">代码示例</span><span class="sxs-lookup"><span data-stu-id="78dc8-143">Code sample</span></span>

<span data-ttu-id="78dc8-144">显示选项卡身份验证过程的示例代码：</span><span class="sxs-lookup"><span data-stu-id="78dc8-144">Sample code showing the tab authentication process:</span></span>

| <span data-ttu-id="78dc8-145">**示例名称**</span><span class="sxs-lookup"><span data-stu-id="78dc8-145">**Sample name**</span></span> | <span data-ttu-id="78dc8-146">**说明**</span><span class="sxs-lookup"><span data-stu-id="78dc8-146">**Description**</span></span> | <span data-ttu-id="78dc8-147">**C#**</span><span class="sxs-lookup"><span data-stu-id="78dc8-147">**C#**</span></span> | <span data-ttu-id="78dc8-148">**Node.js**</span><span class="sxs-lookup"><span data-stu-id="78dc8-148">**Node.js**</span></span> |
|-----------------|-----------------|-------------|------------|
| <span data-ttu-id="78dc8-149">Teams选项卡身份验证</span><span class="sxs-lookup"><span data-stu-id="78dc8-149">Teams tab authentication</span></span> | <span data-ttu-id="78dc8-150">使用 AAD 的选项卡的身份验证过程。</span><span class="sxs-lookup"><span data-stu-id="78dc8-150">Authentication process for tabs using AAD.</span></span> | [<span data-ttu-id="78dc8-151">View</span><span class="sxs-lookup"><span data-stu-id="78dc8-151">View</span></span>](https://github.com/OfficeDev/Microsoft-Teams-Samples/tree/main/samples/app-complete-sample/csharp) | [<span data-ttu-id="78dc8-152">View</span><span class="sxs-lookup"><span data-stu-id="78dc8-152">View</span></span>](https://github.com/OfficeDev/Microsoft-Teams-Samples/tree/main/samples/app-complete-sample/nodejs) |

## <a name="more-details"></a><span data-ttu-id="78dc8-153">更多详细信息</span><span class="sxs-lookup"><span data-stu-id="78dc8-153">More details</span></span>

<span data-ttu-id="78dc8-154">有关使用 AAD 进行选项卡身份验证的详细实现，请参阅：</span><span class="sxs-lookup"><span data-stu-id="78dc8-154">For a detailed implementation for tab authentication using AAD, see:</span></span>

* [<span data-ttu-id="78dc8-155">在"用户"选项卡中Teams用户</span><span class="sxs-lookup"><span data-stu-id="78dc8-155">Authenticate a user in a Teams tab</span></span>](~/tabs/how-to/authentication/auth-tab-AAD.md)
* [<span data-ttu-id="78dc8-156">无提示的身份验证</span><span class="sxs-lookup"><span data-stu-id="78dc8-156">Silent authentication</span></span>](~/tabs/how-to/authentication/auth-silent-AAD.md)
