### YamlMime:Tutorial
title: 选项卡和消息扩展的 SSO
metadata:
  title: 选项卡和消息扩展的 SSO
  description: 通过本学习模块，了解如何为选项卡设置 Azure AD SSO)  (Azure Active Directory 单一登录。
  audience: Developer
  level: Beginner
  ms.date: 12/07/2021
  ms.topic: interactive-tutorial
  nextTutorialHref: tabs/how-to/authentication/tab-sso-overview.md
  nextTutorialTitle: 详细了解选项卡的 SSO 身份验证。
  ms.custom: mvc
  ms.localizationpriority: high
  ms.openlocfilehash: 7932c22485aaeffc39bd1339e92740afe51396e6
  ms.sourcegitcommit: 31032e3dee47232c3f8fc9ed1f2168cc0cbcfb7e
  ms.translationtype: MT
  ms.contentlocale: zh-CN
  ms.lasthandoff: 09/21/2022
  ms.locfileid: "67858928"
items:
- durationInMinutes: 1
  content: "Azure AD SSO (Azure Active Directory 单一登录) 有助于对 Teams 中的用户进行身份验证。 \n\n**用于选项卡和消息扩展的 Azure AD SSO 分步指南的关键方面**：\n\n * 首次登录后，Azure AD SSO 允许用户自动登录。\n * 允许用户登录到其他设备，而无需再次输入登录凭据。\n * 获取登录用户的令牌。   \n\n本分步指南可帮助你创建启用 Azure AD SSO 身份验证的选项卡和消息扩展。 你将看到以下输出：\n\n  ![恭喜图片](~/assets/images/Tab-ME-SSO/hello-megan-profile245.png)   \n"
- title: 先决条件
  durationInMinutes: 1
  content: "确保安装以下工具并设置开发环境：  \n\n* 具有有效帐户[的 Microsoft Teams](https://teams.microsoft.com/)\n* [.NET Core SDK](https://dotnet.microsoft.com/download) 版本 3.1\n* [最新版本的 Visual Studio](https://visualstudio.microsoft.com/downloads/)\n* [ngrok](https://ngrok.com/download) 最新版本 (仅用于开发人员箱测试) 或任何等效的隧道解决方案\n* [Microsoft 365 开发人员帐户](/microsoftteams/platform/concepts/build-and-test/prepare-your-o365-tenant) 或具有安装应用适当权限的 Teams 帐户的访问权限\n\n  > [!NOTE]\n  > 下载 ngrok 后，注册并安装 [身份验证](https://ngrok.com/download)。\n"
- title: 设置本地环境
  durationInMinutes: 1
  content: "将存储库克隆 `Microsoft-Teams-Samples` 到本地 GitHub：  \n\n 1. 打开 [Microsoft Teams 示例](https://github.com/OfficeDev/Microsoft-Teams-Samples)。\n 1. 选择 **“代码**”。\n 1. 在下拉菜单中，选择 **“使用 GitHub Desktop 打开**”。\n\n    ![克隆存储库](~/assets/images/meeting-token-generator/meeting-token-generator-clonerepository.png)\n\n 1. 选择 **“克隆**”。 \n"
- title: 在 Azure AD 门户中创建和注册机器人
  durationInMinutes: 5
  content: "以下步骤指导你：\n\n* 创建 Azure 机器人资源以将机器人注册到 Azure 机器人服务。\n* 创建支持机器人 SSO 身份验证的客户端机密。\n* 添加 Microsoft Teams 通道以将机器人部署到 Teams 频道。\n* 使用 ngrok 创建到 Web 服务器终结点的隧道。\n* 将消息传送终结点添加到创建的 ngrok 隧道。\n\n**创建 Azure 机器人资源**\n\n1. 转到 [Microsoft Azure 门户](https://portal.azure.com/)。\n1. 选择“**创建资源**”。\n1. 在搜索框中，输入 **Azure 机器人**。\n1. 选择“**Enter**”。\n1. 选择 **Azure 机器人**。\n\n     :::image type=\"content\" source=\"./assets/images/azure-bot.png\" alt-text=\"Azure 机器人。\":::\n     \n1. 选择“**创建**”。\n1. 在 **机器人句柄** 中输入所需的机器人句柄名称。\n1. 从下拉列表中选择 **订阅** 。\n1. 从 **“资源组** ”下拉列表中，选择现有的资源组。 还可以创建新的资源组 (选择 **“新建** >输入资源名称>选择 **”确定** “) 。\n\n    ![注册机器人](~/assets/images/Tab-ME-SSO/register-bot.png)\n\n1. 在 **“Microsoft 应用 ID”** 部分中，默认选择 **“新建 Microsoft 应用 ID** ”。 \n\n   选择 **“使用现有应用注册** ”，并输入 **现有应用程序的现有应用 ID** 和 **现有应用密码** 。 选择 **“为新应用程序创建新的 Microsoft 应用 ID** ”。\n\n   > [!NOTE]\n   > 不能创建具有相同 **Microsoft 应用 ID** 的多个机器人。\n\n1. 选择 **“应用类型”** 作为 `Multi Tenant`。\n1. 然后“**审阅 + 创建**”。\n\n   ![注册机器人](~/assets/images/Tab-ME-SSO/register-bot-2.png)\n\n1. 如果验证通过，请选择“**创建**”。\n\n    预配机器人服务需要一些时间。\n\n1. 选择“**转到资源**”。 \n\n    ![部署应用](~/assets/images/Tab-ME-SSO/go-to-resource.png)\n\n    Azure 机器人已创建。\n\n    ![部署应用](~/assets/images/Tab-ME-SSO/app-overview.png)\n\n**创建客户端机密**\n\n  如果已创建新的 **Microsoft 应用 ID**，请执行以下步骤：\n\n1. 在左侧面板中，选择 **“配置**”。 \n\n   > [!TIP]\n   > 保存 **Microsoft 应用 ID** 或 **客户端 ID** 以供将来参考。\n\n1. 在 **Microsoft 应用 ID** 旁边，选择 **“管理**”。\n\n    ![Microsoft 应用 ID](~/assets/images/Tab-ME-SSO/manage.png)\n\n1. 在 **“客户端机密** ”部分中，选择 **“新建客户端机密**”。 \n\n    ![新客户端机密](~/assets/images/meeting-token-generator/meeting-token-generator-newclientsecret.png)\n\n   将显示 **“添加客户端机密** ”窗口。  \n\n1. 输入 **说明**。\n\n1. 选择“**添加**”。\n\n    ![将客户端机密添加到应用](~/assets/images/Tab-ME-SSO/add-client-id.png)\n\n1. 在 **“值** ”列中，选择 **“复制到剪贴板**”。\n\n     ![客户端机密的值](~/assets/images/Tab-ME-SSO/client-ids.png)\n   \n   > [!TIP]\n   > 保存 **客户端机密** 值或应用密码以供将来参考。\n\n**添加 Microsoft Teams 频道**\n\n1. 选择“主页”。\n\n    ![主页](~/assets/images/Tab-ME-SSO/home.png)\n\n1. 从 **最近的资源** 中选择机器人。\n\n1. 在左窗格中选择 **“通道** ”。 \n\n1. 选择 **Microsoft Teams** <img src=\"~/assets/images/bots/teamsicon.png\" alt=\"Teams icon\" width=\"20\"/>.\n\n1. 选中该复选框以接受 **服务条款**。\n\n1. 选择 **“同意**”。\n\n      ![服务条款](~/assets/images/meeting-token-generator/meeting-token-generator-terms.png)\n\n1. 选择“保存”。\n\n      ![选择 Teams](~/assets/images/meeting-token-generator/meeting-token-generator-config-teams.png)   \n\n**为本地 Web 服务器创建隧道**\n\n使用 ngrok 创建到本地运行的 Web 服务器的公开可用 HTTPS 终结点的隧道。 在 ngrok 中运行以下命令：\n\n ```bash\n ngrok http -host-header=localhost 3978\n ```\n\n**添加消息传送终结点**\n\n1. 从 ngrok 将 HTTPS URL (https 复制到 io) 。\n\n    ![ngrok HTTPS URL](~/assets/images/Tab-ME-SSO/ngrok-image.png)\n\n    > [!NOTE]\n    > ngrok 中的 HTTPS URL 是完全限定的域名。\n    > 这是 `WebAppDomain` 一个完全限定的域名，不包括 `https://` 在其中。\n\n1. 在创建的 Azure 机器人 **的“设置”** 中，选择 **“配置**”。\n\n1. 在 **消息传送终结点** 中，使用 ngrok 提供的 HTTPS URL，并在 URL 末尾添加 **/api/messages**。\n\n    ![消息传送终结点](~/assets/images/Tab-ME-SSO/messaging-endpoint.png)\n\n1. 选择“**应用**”。\n\n    已在 Azure 机器人服务中成功设置机器人。\n"
- title: 为选项卡配置 SSO
  durationInMinutes: 1
  content: "1. 转到“[Azure 门户](https://portal.azure.com/)”。\n\n1. 选择“Azure Active Directory”。\n\n1. 在左窗格中，选择 **“应用注册**”。\n\n1. 选择机器人。\n\n1. 选择 **“公开 API**”。\n\n1. 选择 **“设置**”。\n\n   ![公开 API](~/assets/images/Tab-ME-SSO/application-id-set.png)\n\n1. 设置应用程序 **ID URI** 的形式 `api://your ngrok/botid-{your AppID}`。\n\n   ![设置链接](~/assets/images/Tab-ME-SSO/appid-uri1.png)\n    \n1. 选择“**添加作用域**”。 \n\n1. 在显示的面板中，输入 `access_as_user` 为 **范围名称**。\n\n1. 将 **谁可以同意？** `Admins and users`\n\n1. 若要配置具有相应作用域值 `access_as_user` 的管理员和用户同意提示，请在字段中提供以下信息：</br>\n\n   * 输入`Teams can access the user’s profile`为 **管理员许可显示名称**。\n\n   * 输入`Allows Teams to call the app’s web APIs as the current user`为 **管理员同意说明**。\n\n   * 输入 `Teams can access the user profile and make requests on the user’s behalf` 为 **用户同意显示名称**。\n\n   * 输入 `Enable Teams to call this app’s APIs with the same rights as the user` 为 **用户同意说明**。\n\n1. 确保将“状态”设置为“已启用”。\n\n1. 选择 **“添加范围** ”以保存。\n\n   ![Scopes](~/assets/images/Tab-ME-SSO/add-a-scope.png)\n\n    > [!NOTE]\n    > **范围名称** 应与应用程序 **ID** URI 匹配，`/access_as_user`并追加在末尾。</br>\n       `api://your ngrok/botid-00000000-0000-0000-0000-000000000000/access_as_user`\n\n      ![Scopes](~/assets/images/Tab-ME-SSO/add-a-scope-final1.png) \n\n1. 在“**授权客户端应用程序**”部分中，确定要授权给应用的 Web 应用程序的应用程序。 \n\n1. 选择 **添加客户端应用程序**。 \n\n1. 输入以下每个客户端 ID，然后选择授权范围：</br>\n\n     * `1fec8e78-bce4-4aaf-ab1b-5451cc387264` (Teams 移动或桌面应用程序) \n\n       ![添加客户端应用程序](~/assets/images/Tab-ME-SSO/add-client-application.png) \n\n     * `5e3ce6c0-2b1f-4285-8d4b-75ee78787346` (Teams Web 应用程序) \n\n       ![添加客户端应用程序](~/assets/images/Tab-ME-SSO/add-client-application21.png) \n    \n\n   下图显示 **客户端 ID**：\n\n     ![客户端应用程序](~/assets/images/Tab-ME-SSO/client-id-2.png) \n\n1. 在左侧面板中，选择 **API 权限**。 \n\n   > [!NOTE]\n   > 仅当 Azure AD 应用在其他租户中注册时，用户才需要同意这些权限。\n\n1. 选择“**添加权限**”。\n\n1. 选择 **Microsoft Graph**。\n\n   ![Microsoft Graph](~/assets/images/Tab-ME-SSO/microsoft-graph.png)\n\n1. 选择“**委托的权限**”。\n\n1. 添加以下权限：</br>\n    * **email**\n    * **offline_access**\n    * **Openid**\n    * **个人资料**\n    * **User.Read**\n\n1. 选择 **添加权限**。\n\n1. 在左侧面板中，选择 **“身份验证** ”以设置重定向 URI。 \n\n   > [!NOTE]\n   > 如果未向应用授予 IT 管理员许可，则用户必须在第一次使用应用时提供同意。\n           \n     1. 选择 **添加平台**。\n     1. 选择“Web”\n\n        ![Web](~/assets/images/Tab-ME-SSO/configure-platform1.png)\n\n     1. 输入 **重定向 URI** 作为 `https://token.botframework.com/.auth/web/redirect`.\n\n     1. 通过选择以下复选框启用 **隐式授予和混合流** ：\n         * **ID 令牌**\n         * **访问令牌**\n\n     1. 选择“**配置**”。\n\n        ![配置 Web](~/assets/images/Tab-ME-SSO/configure-web.png)\n\n**更新清单**\n\n1. 从左窗格中选择“**清单**”。\n\n1. 确保配置项设置为 **\"accessTokenAcceptedVersion\": 2**。 如果没有，请将其值更改为 **2** ，然后选择 **“保存**”。 \n\n   > [!Tip]\n   > 如果已在 Teams 中测试机器人，则必须注销机器人并注销 Teams。 然后再次登录以查看此更改。\n\n   ![更新清单](~/assets/images/bots/update-manifest.png)</br>\n\n**设置机器人服务连接**\n\n1. 转到 **“配置”页** > **“添加 OAuth 连接设置**”。\n\n1. 选择“**添加 OAuth 连接设置**”。\n\n1. 在 **“新建连接设置**”中，输入以下详细信息：\n\n    | 字段 | 值或描述 |\n    | ----- | ----- |\n    | **名称** | 输入新连接设置的名称。 可以在机器人服务代码的设置中使用该名称。 |\n    | **服务提供程序** | 选择 **Azure Active Directory V2**。 |\n    | **客户端 ID** | 之前保存为 **Microsoft 应用 ID**。 |\n    | **客户端密码** | 之前保存为客户端机密 ID 的 **值** 。 |\n    | **令牌交换 URL** | 使用之前在公开 API 终结点时获取的应用程序 **ID URI** 。 |\n    | **租户 ID** | 输入 **common**。 |\n    | **Scopes** | 输入 **User.Read** ，并在指定对下游 API 的权限时添加所选的所有 **范围** 。 |\n\n1. 选择“**保存**”。\n\n    <img src=\"~/assets/images/Tab-ME-SSO/new-connection-setting.png\" alt=\"Bot Service connection\" width=\"300\"/>\n"
- title: 设置应用设置
  durationInMinutes: 1
  content: "1. 导航到克隆存储库中的 **appsettings.json** 。\n\n    ![应用设置位置](~/assets/images/Tab-ME-SSO/app-setting-folder.png)\n\n1. 在 **Visual Studio Code** 中打开 **appsettings.json**，并更新以下信息：  \n\n     * 设置 `\"MicrosoftAppId\"` 为机器人的 **Microsoft 应用 ID**。\n     * 设置 `\"MicrosoftAppPassword\"` 为机器人的客户端机密 ID 值。\n     * 设置 `\"DOMAIN-NAME\"` 为 ngrok URL。\n     * 设置 `\"ConnectionName\"` 为 OAuth 连接设置的名称。\n     * 设置 `\"ClientId\"` 为机器人的 **Microsoft 应用 ID**。\n     * 设置 `\"AppSecret\"` 为机器人的客户端机密 ID 值。\n     * 以 .`\"ApplicationIdURI\"`.`api://584f****.ngrok.io/botid-{AppID}`\n\n    ![应用设置](~/assets/images/Tab-ME-SSO/app-setting1.png)\n"
- title: 设置清单文件
  durationInMinutes: 1
  content: "1. 在克隆的存储库中导航到 `manifest.json` 。\n\n    ![清单文件位置](~/assets/images/Tab-ME-SSO/folder-manifest.png)\n\n1. 在 **Visual Studio Code** 中打开`manifest.json`并进行以下更改：\n\n     * 将所有出现的 `[DOMAIN-NAME]` 域名替换为 ngrok 域名。 \n     * 将所有事件 `[YOUR-MICROSOFT-APP-ID]` 替换为机器人的 **Microsoft 应用 ID**。\n\n         > [!NOTE]\n         > 具体取决于方案 `[YOUR-MICROSOFT-APP-ID]` ，可能会 `[DOMAIN-NAME]` 发生多次。\n\n     * 设置 `\"resource\"` 为 `api://584f****.ngrok.io/botid-{AppID}`.</br>\n    \n    ![清单映像 2](~/assets/images/Tab-ME-SSO/vs-manifest.png)\n"
- title: 生成并运行服务
  durationInMinutes: 1
  content: "**使用 Visual Studio 2019 或命令行生成和运行服务**\n\n# <a name=\"visual-studio-2019\"></a>[Visual Studio 2019](#tab/vs2019)\n\n   1. 启动 **Visual Studio 2019**。\n   1. 导航到 **文件** > **打开** > **项目/解决方案**。\n\n      ![打开文件](~/assets/images/Tab-ME-SSO/open-project1.png)\n\n   1. 从 **csharp** 文件夹 **中选择 App SSO Sample.csproj** 文件。\n\n      ![项目文件夹](~/assets/images/Tab-ME-SSO/project-folder1.png)\n\n   1. 你将看到以下输出：\n\n      ![令牌文件](~/assets/images/Tab-ME-SSO/output1.png)\n\n   1. 按 **F5** 运行项目。\n\n   1. 如果出现以下对话框，请选择“**是**”：\n\n      ![信任证书](~/assets/images/sbs-outgoing-webhooks/outgoing-webhook-certificate.png)\n\n      随即会打开一个网页，其中包含一条消息： **机器人已准备就绪！**\n\n      ![应用准备就绪](~/assets/images/Tab-ME-SSO/bot-completion-explorer.png) \n\n    \n# <a name=\"command-line\"></a>[命令行](#tab/cli)\n\n在命令提示符窗口中导航到 **csharp** 文件夹，并输入以下命令：\n\n```bash\ndotnet run\n```\n\n![Dotnet](~/assets/images/Tab-ME-SSO/dotnet-run1.png)\n  \n"
- title: 将 SSO 应用上传到 Teams
  durationInMinutes: 1
  content: "1. 在克隆的存储库中，导航到 **csharp > App SSO 示例 > TeamsAppManifest**。\n\n1. 使用 **清单** 文件夹中存在的以下文件创建.zip： \n   * manifest.json\n   * icon-outline.png\n   * icon-color.png\n\n   ![选择 zip 文件](~/assets/images/Tab-ME-SSO/upload-tab-me-sso.png)\n\n1. 转到 **Microsoft Teams**。\n\n1. 选择 **“存储”。**\n1. 选择“**管理应用**”。\n1. 选择“**发布应用**”。\n\n   ![Dotnet](~/assets/images/Tab-ME-SSO/publish-an-app.png)\n\n1. 选择“**上传自定义应用**”。 \n\n   ![上传自定义应用](~/assets/images/Tab-ME-SSO/upload-custom-app.png)\n\n1. 选择 **“打开** ”以上传在 **清单** 文件夹中创建的.zip文件。\n\n   ![选择 zip 文件](~/assets/images/Tab-ME-SSO/upload-tab-me-sso-open.png)\n\n1. 选择“**添加**”。\n\n   ![添加应用](~/assets/images/Tab-ME-SSO/add-sso-app.png)\n\n1. 向机器人发送消息。 \n1. 机器人将执行单一登录并显示配置文件卡以及查看令牌的选项提示。\n\n   ![个人资料卡片](~/assets/images/Tab-ME-SSO/Congratulation-image.png)\n\n1. 选择 **“是** ”以查看令牌或 **“否** ”以继续聊天。\n  \n   ![令牌视图](~/assets/images/Tab-ME-SSO/token-view1.png)\n\n  1. 如果未执行 SSO，则机器人将为选项卡执行默认身份验证方法。\n\n      ![无 SSO](~/assets/images/Tab-ME-SSO/not-login11.png)\n\n  1. 选择省略号 **...**\n\n      ![消息扩展](~/assets/images/Tab-ME-SSO/message-extension.png)\n  \n  1. 选择新的 SSO 应用程序。\n\n      ![SSO 应用](~/assets/images/Tab-ME-SSO/recent-app-sso.png)\n\n  1. 选择 **登录**。\n\n      ![登录](~/assets/images/Tab-ME-SSO/sign-in-sso1.png)\n\n  1. 在登录框中输入凭据，然后选择 **“下一步**”。\n\n      ![登录框](~/assets/images/Tab-ME-SSO/sign-in-box.png)\n  \n  1. 选择“**接受**”。\n\n      ![同意框](~/assets/images/Tab-ME-SSO/concent-box.png)\n\n  1. 打开消息扩展并选择应用程序。\n\n  1. 在搜索框下选择配置文件。 你将看到如下所示：\n\n      ![配置文件](~/assets/images/Tab-ME-SSO/hello-megan-profile.png)\n\n  1. 发送 `https://profile.botframework.com` 到应用程序以获取配置文件卡。\n   \n      ![个人资料卡片](~/assets/images/Tab-ME-SSO/profile-card.png)\n"
- title: 完成质询
  durationInMinutes: 1
  content: >
    你想出了这样的事吗？

       ![SSO 配置文件](~/assets/images/Tab-ME-SSO/hello-megan-profile245.png)
- content: 你已完成教程，以开始使用用于选项卡和消息扩展应用的 SSO。
