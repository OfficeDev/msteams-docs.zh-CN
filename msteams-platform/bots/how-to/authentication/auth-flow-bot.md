---
title: Microsoft Teams自动程序身份验证流
description: 介绍Microsoft Teams中的身份验证流
keywords: teams 身份验证流自动程序
localization_priority: Normal
ms.topic: overview
ms.openlocfilehash: ede626fe7f531c42d83cf9e74d93b93d70e162c3
ms.sourcegitcommit: 825abed2f8784d2bab7407ba7a4455ae17bbd28f
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 04/26/2021
ms.locfileid: "52020040"
---
# <a name="authentication-flow-for-bots-in-microsoft-teams"></a><span data-ttu-id="0d481-104">聊天机器人的身份验证Microsoft Teams</span><span class="sxs-lookup"><span data-stu-id="0d481-104">Authentication flow for bots in Microsoft Teams</span></span>

<span data-ttu-id="0d481-105">OAuth 2.0 是 Azure Active Directory (Azure AD) 和许多其他身份标识提供程序用于身份验证和授权的开放标准。</span><span class="sxs-lookup"><span data-stu-id="0d481-105">OAuth 2.0 is an open standard for authentication and authorization used by Azure Active Directory (Azure AD) and many other identity providers.</span></span> <span data-ttu-id="0d481-106">对 OAuth 2.0 有基本的了解是在身份验证中Teams;[下面是比正式](https://aaronparecki.com/oauth-2-simplified/)规范更易于遵循的一个很好的[概述](https://oauth.net/2/)。</span><span class="sxs-lookup"><span data-stu-id="0d481-106">A basic understanding of OAuth 2.0 is a prerequisite for working with authentication in Teams; [here's a good overview](https://aaronparecki.com/oauth-2-simplified/) that's easier to follow than the [formal specification](https://oauth.net/2/).</span></span> <span data-ttu-id="0d481-107">选项卡和聊天机器人的身份验证流有一点不同 ：选项卡与网站非常相似，因此可以直接使用 OAuth 2.0，而机器人不会并且必须执行一些不同的操作，但核心概念是相同的。</span><span class="sxs-lookup"><span data-stu-id="0d481-107">Authentication flow for tabs and bots is a little different — tabs are very similar to websites so they can use OAuth 2.0 directly, while bots aren't and must do a few things differently — but the core concepts are identical.</span></span>

<span data-ttu-id="0d481-108">有关演示GitHub和[OAuth 2.0](https://oauth.net/2/grant-types/authorization-code/)授权代码授予Node.js自动程序身份验证流的示例，请参阅 GitHub [Microsoft Teams](https://github.com/OfficeDev/Microsoft-Teams-Samples/tree/main/samples/app-auth/nodejs)存储库和身份验证示例。</span><span class="sxs-lookup"><span data-stu-id="0d481-108">See the GitHub repo [Microsoft Teams Authentication Sample](https://github.com/OfficeDev/Microsoft-Teams-Samples/tree/main/samples/app-auth/nodejs) for an example that demonstrates authentication flow for bots using Node.js and the [OAuth 2.0 authorization code grant type](https://oauth.net/2/grant-types/authorization-code/).</span></span>

![自动程序身份验证序列图](../../../assets/images/authentication/bot_auth_sequence_diagram.png)

1. <span data-ttu-id="0d481-110">用户向自动程序发送消息。</span><span class="sxs-lookup"><span data-stu-id="0d481-110">The user sends a message to the bot.</span></span>
2. <span data-ttu-id="0d481-111">自动程序确定用户是否需要登录。</span><span class="sxs-lookup"><span data-stu-id="0d481-111">The bot determines if the user needs to sign in.</span></span>
   <span data-ttu-id="0d481-112">本示例中，自动程序将访问令牌存储在其用户数据存储中。</span><span class="sxs-lookup"><span data-stu-id="0d481-112">In this example, the bot stores the access token in its user data store.</span></span> <span data-ttu-id="0d481-113">如果所选标识提供程序没有经过验证的令牌，它会要求用户登录。</span><span class="sxs-lookup"><span data-stu-id="0d481-113">It asks the user to sign in if it doesn't have a validated token for the selected identity provider.</span></span> <span data-ttu-id="0d481-114"> ([查看代码](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/utils/AuthenticationUtils.ts#L58-L76)) </span><span class="sxs-lookup"><span data-stu-id="0d481-114">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/utils/AuthenticationUtils.ts#L58-L76))</span></span>
3. <span data-ttu-id="0d481-115">机器人构建身份验证流起始页的 URL，然后通过操作向用户发送 `signin` 卡片。</span><span class="sxs-lookup"><span data-stu-id="0d481-115">The bot constructs the URL to the start page of the authentication flow, and sends a card to the user with a `signin` action.</span></span> <span data-ttu-id="0d481-116"> ([查看代码](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/dialogs/BaseIdentityDialog.ts#L160-L190)) </span><span class="sxs-lookup"><span data-stu-id="0d481-116">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/dialogs/BaseIdentityDialog.ts#L160-L190))</span></span></br>
    <span data-ttu-id="0d481-117">与应用程序中的Teams一样，起始页必须位于列表上的域中，并且与登录后重定向页位于同一 `validDomains` 域中。</span><span class="sxs-lookup"><span data-stu-id="0d481-117">Like other application auth flows in Teams, the start page must be in a domain that's on your `validDomains` list, and in the same domain as the post-login redirect page.</span></span>
    > [!IMPORTANT] 
    > <span data-ttu-id="0d481-118">OAuth 2.0 授权代码授予对身份验证请求中参数的调用，该请求包含一个唯一的会话令牌，用于防止跨站点请求 `state` [伪造攻击](https://en.wikipedia.org/wiki/Cross-site_request_forgery)。</span><span class="sxs-lookup"><span data-stu-id="0d481-118">The OAuth 2.0 authorization code grant flow calls for a `state` parameter in the authentication request which contains a unique session token to prevent a [cross-site request forgery attack](https://en.wikipedia.org/wiki/Cross-site_request_forgery).</span></span> <span data-ttu-id="0d481-119">此示例使用随机生成的 GUID。</span><span class="sxs-lookup"><span data-stu-id="0d481-119">The example uses a randomly-generated GUID.</span></span>
4. <span data-ttu-id="0d481-120">当用户选择登录按钮时，Teams打开一个弹出窗口并导航到起始页。 </span><span class="sxs-lookup"><span data-stu-id="0d481-120">When the user selects the *signin* button, Teams opens a popup window and navigates to the start page.</span></span>
   > [!NOTE]
   > <span data-ttu-id="0d481-121">弹出窗口的大小可以通过 URL 中的 width 和 height 查询字符串参数进行控制。</span><span class="sxs-lookup"><span data-stu-id="0d481-121">The size of the pop-up window can be controlled through width and height query string parameters in the URL.</span></span> <span data-ttu-id="0d481-122">例如，如果添加 width=500 且 height=500，则弹出窗口的大小为 500x500 像素。</span><span class="sxs-lookup"><span data-stu-id="0d481-122">For example, if you add width=500 and height=500, the size of the pop-up window is 500x500 pixels.</span></span> <span data-ttu-id="0d481-123">Teams显示具有给定像素大小的弹出窗口，最大像素大小为主窗口大小的百分比。</span><span class="sxs-lookup"><span data-stu-id="0d481-123">Teams displays the pop-up window with the given pixel size, up to a maximum that's a percentage of the size of the main window.</span></span>

5. <span data-ttu-id="0d481-124">起始页将用户重定向到标识提供程序的 `authorize` 终结点。</span><span class="sxs-lookup"><span data-stu-id="0d481-124">The start page redirects the user to the identity provider's `authorize` endpoint.</span></span> <span data-ttu-id="0d481-125"> ([查看代码](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/public/html/auth-start.html#L51-L56)) </span><span class="sxs-lookup"><span data-stu-id="0d481-125">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/public/html/auth-start.html#L51-L56))</span></span>
6. <span data-ttu-id="0d481-126">在提供商的网站上，用户登录并授予对机器人的访问权限。</span><span class="sxs-lookup"><span data-stu-id="0d481-126">On the provider's site, the user signs in and grants access to the bot.</span></span>
7. <span data-ttu-id="0d481-127">提供程序使用授权代码将用户定向到机器人的 OAuth 重定向页面。</span><span class="sxs-lookup"><span data-stu-id="0d481-127">The provider takes the user to the bot's OAuth redirect page with an authorization code.</span></span>
8. <span data-ttu-id="0d481-128">机器人兑换授权代码获取访问令牌，并临时将令牌与启动登录流程的用户关联。</span><span class="sxs-lookup"><span data-stu-id="0d481-128">The bot redeems the authorization code for an access token, and **provisionally** associates the token with the user that initiated the sign-in flow.</span></span> <span data-ttu-id="0d481-129">在下面，我们将此称为 *临时令牌*。</span><span class="sxs-lookup"><span data-stu-id="0d481-129">Below, we call this a *provisional token*.</span></span>
    * <span data-ttu-id="0d481-130">在示例中，自动程序将参数值与启动登录过程的用户的 ID 关联，以便以后可以与标识提供程序返回的值 `state` `state` 匹配。</span><span class="sxs-lookup"><span data-stu-id="0d481-130">In the example, the bot associates the value of the `state` parameter with the ID of the user that initiated the sign-in process so it can later match it with the `state` value returned by the identity provider.</span></span> <span data-ttu-id="0d481-131"> ([查看代码](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/AuthBot.ts#L70-L99)) </span><span class="sxs-lookup"><span data-stu-id="0d481-131">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/AuthBot.ts#L70-L99))</span></span>
      > [!IMPORTANT] 
      > <span data-ttu-id="0d481-132">自动程序存储从标识提供程序收到的令牌，并关联到特定用户，但标记为"待验证"。</span><span class="sxs-lookup"><span data-stu-id="0d481-132">The bot stores the token it receives from the identity provider and associates it with a specific user, but it is marked as "pending validation".</span></span> 
    * <span data-ttu-id="0d481-133">临时令牌如果不进一步验证，则不能使用。</span><span class="sxs-lookup"><span data-stu-id="0d481-133">The provisional token can't be used without further validation.</span></span>
      1. <span data-ttu-id="0d481-134">**验证从标识提供程序接收的信息。**</span><span class="sxs-lookup"><span data-stu-id="0d481-134">**Validate what's received from the identity provider.**</span></span> <span data-ttu-id="0d481-135">必须针对 `state` 之前保存的值确认参数的值。</span><span class="sxs-lookup"><span data-stu-id="0d481-135">The value of the `state` parameter must be confirmed against what was saved earlier.</span></span> 
      1. <span data-ttu-id="0d481-136">**验证接收自Teams。**</span><span class="sxs-lookup"><span data-stu-id="0d481-136">**Validate what's received from Teams.**</span></span> <span data-ttu-id="0d481-137">执行 [两步身份验证](https://en.wikipedia.org/wiki/Man-in-the-middle_attack) 验证，以确保通过标识提供程序授权自动程序的用户是正在与机器人聊天的同一用户。</span><span class="sxs-lookup"><span data-stu-id="0d481-137">A [two-step authentication](https://en.wikipedia.org/wiki/Man-in-the-middle_attack) validation is performed to ensure that the user who authorized the bot with the identity provider is the same user who is chatting with the bot.</span></span> <span data-ttu-id="0d481-138">这可[抵御中间人和网络钓鱼](https://en.wikipedia.org/wiki/Man-in-the-middle_attack)[攻击。](https://en.wikipedia.org/wiki/Phishing)</span><span class="sxs-lookup"><span data-stu-id="0d481-138">This guards against [man-in-the-middle](https://en.wikipedia.org/wiki/Man-in-the-middle_attack) and [phishing](https://en.wikipedia.org/wiki/Phishing) attacks.</span></span> <span data-ttu-id="0d481-139">机器人生成验证码，并存储与用户关联的验证码。</span><span class="sxs-lookup"><span data-stu-id="0d481-139">The bot generates a verification code and stores it, associated with the user.</span></span> <span data-ttu-id="0d481-140">验证码由用户自动发送Teams如下所述。</span><span class="sxs-lookup"><span data-stu-id="0d481-140">The verification code is sent automatically by Teams as described below.</span></span> <span data-ttu-id="0d481-141"> ([查看代码](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/AuthBot.ts#L100-L113)) </span><span class="sxs-lookup"><span data-stu-id="0d481-141">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/AuthBot.ts#L100-L113))</span></span>
9. <span data-ttu-id="0d481-142">OAuth 回调呈现调用 的页面 `notifySuccess("<verification code>")` 。</span><span class="sxs-lookup"><span data-stu-id="0d481-142">The OAuth callback renders a page that calls `notifySuccess("<verification code>")`.</span></span> <span data-ttu-id="0d481-143"> ([查看代码](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/master/src/views/oauth-callback-success.hbs)) </span><span class="sxs-lookup"><span data-stu-id="0d481-143">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/master/src/views/oauth-callback-success.hbs))</span></span>
10. <span data-ttu-id="0d481-144">Teams关闭弹出窗口，并将发送的 `<verification code>` `notifySuccess()` 发送回自动程序。</span><span class="sxs-lookup"><span data-stu-id="0d481-144">Teams closes the pop-up window and sends the `<verification code>` sent to `notifySuccess()` back to the bot.</span></span> <span data-ttu-id="0d481-145">机器人通过 接收 [调用](/bot-framework/dotnet/bot-builder-dotnet-activities#invoke) 消息 `name = signin/verifyState` 。</span><span class="sxs-lookup"><span data-stu-id="0d481-145">The bot receives an [invoke](/bot-framework/dotnet/bot-builder-dotnet-activities#invoke) message with `name = signin/verifyState`.</span></span>
11. <span data-ttu-id="0d481-146">自动程序根据使用用户临时令牌存储的验证码检查传入验证码。</span><span class="sxs-lookup"><span data-stu-id="0d481-146">The bot checks the incoming verification code against the verification code stored with the user's provisional token.</span></span> <span data-ttu-id="0d481-147"> ([查看代码](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/dialogs/BaseIdentityDialog.ts#L127-L140)) </span><span class="sxs-lookup"><span data-stu-id="0d481-147">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/dialogs/BaseIdentityDialog.ts#L127-L140))</span></span>
12. <span data-ttu-id="0d481-148">如果匹配，则自动程序将令牌标记为已验证并可供使用。</span><span class="sxs-lookup"><span data-stu-id="0d481-148">If they match, the bot marks the token as validated and ready for use.</span></span> <span data-ttu-id="0d481-149">否则，身份验证流将失败，自动程序会删除临时令牌。</span><span class="sxs-lookup"><span data-stu-id="0d481-149">Otherwise, the auth flow fails, and the bot deletes the provisional token.</span></span>

    > [!NOTE]
    > <span data-ttu-id="0d481-150">如果你在移动设备上遇到身份验证问题，请确保 JavaScript SDK 已更新到版本 1.4.1 或更高版本。</span><span class="sxs-lookup"><span data-stu-id="0d481-150">If you experience issues with authentication on mobile, ensure your JavaScript SDK is updated to version 1.4.1 or later.</span></span>

## <a name="code-sample"></a><span data-ttu-id="0d481-151">代码示例</span><span class="sxs-lookup"><span data-stu-id="0d481-151">Code sample</span></span>

<span data-ttu-id="0d481-152">显示自动程序身份验证过程的示例代码：</span><span class="sxs-lookup"><span data-stu-id="0d481-152">Sample code showing the bot authentication process:</span></span>

| <span data-ttu-id="0d481-153">**示例名称**</span><span class="sxs-lookup"><span data-stu-id="0d481-153">**Sample name**</span></span> | <span data-ttu-id="0d481-154">**说明**</span><span class="sxs-lookup"><span data-stu-id="0d481-154">**Description**</span></span> | <span data-ttu-id="0d481-155">**Node.js**</span><span class="sxs-lookup"><span data-stu-id="0d481-155">**Node.js**</span></span> | <span data-ttu-id="0d481-156">**.NET**</span><span class="sxs-lookup"><span data-stu-id="0d481-156">**.NET**</span></span> | <span data-ttu-id="0d481-157">**Python**</span><span class="sxs-lookup"><span data-stu-id="0d481-157">**Python**</span></span> |
|-----------------|----------------|--------------|----------|-----------|
| <span data-ttu-id="0d481-158">Teams身份验证</span><span class="sxs-lookup"><span data-stu-id="0d481-158">Teams authentication</span></span> | <span data-ttu-id="0d481-159">此示例演示了Microsoft Teams身份验证。</span><span class="sxs-lookup"><span data-stu-id="0d481-159">This sample demonstrates authentication in Microsoft Teams apps.</span></span> | [<span data-ttu-id="0d481-160">View</span><span class="sxs-lookup"><span data-stu-id="0d481-160">View</span></span>](https://github.com/OfficeDev/microsoft-teams-sample-auth-node) | | |
| <span data-ttu-id="0d481-161">自动程序身份验证</span><span class="sxs-lookup"><span data-stu-id="0d481-161">Bot authentication</span></span> | <span data-ttu-id="0d481-162">此示例将开始对自动程序运行中的自动程序运行Microsoft Teams</span><span class="sxs-lookup"><span data-stu-id="0d481-162">This sample demonstartes how to use authentication for a bot runnning in Microsoft Teams</span></span> | [<span data-ttu-id="0d481-163">View</span><span class="sxs-lookup"><span data-stu-id="0d481-163">View</span></span>](https://github.com/microsoft/BotBuilder-Samples/tree/main/samples/javascript_nodejs/46.teams-auth) | [<span data-ttu-id="0d481-164">View</span><span class="sxs-lookup"><span data-stu-id="0d481-164">View</span></span>](https://github.com/microsoft/BotBuilder-Samples/tree/main/samples/csharp_dotnetcore/46.teams-auth) | [<span data-ttu-id="0d481-165">View</span><span class="sxs-lookup"><span data-stu-id="0d481-165">View</span></span>](https://github.com/microsoft/BotBuilder-Samples/tree/main/samples/python/46.teams-auth)

## <a name="more-details"></a><span data-ttu-id="0d481-166">更多详细信息</span><span class="sxs-lookup"><span data-stu-id="0d481-166">More details</span></span>

<span data-ttu-id="0d481-167">有关面向 Azure AD 的自动程序身份验证的详细实现演练，请参阅：</span><span class="sxs-lookup"><span data-stu-id="0d481-167">For detailed implementation walkthroughs for bot authentication targeting Azure AD see:</span></span>

[<span data-ttu-id="0d481-168">向自动程序Teams身份验证</span><span class="sxs-lookup"><span data-stu-id="0d481-168">Add authentication to your Teams bot</span></span>](add-authentication.md)
